name: Auto-Translate Localizations

on:
  # Run once daily at 3 AM UTC
  schedule:
    - cron: '0 3 * * *'

  # Allow manual trigger for testing
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  translate:
    name: Auto-translate localization strings
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r .github/scripts/requirements.txt

      - name: Run translation script
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          python .github/scripts/translate.py

      - name: Check for changes
        id: check_changes
        run: |
          if [ -f "translation-summary.json" ]; then
            NEW_KEYS=$(jq -r '.new_keys // 0' translation-summary.json)
            MODIFIED_KEYS=$(jq -r '.modified_keys // 0' translation-summary.json)
            DELETED_KEYS=$(jq -r '.deleted_keys // 0' translation-summary.json)
            LANGUAGES=$(jq -r '.languages_updated // 0' translation-summary.json)
          else
            NEW_KEYS=0
            MODIFIED_KEYS=0
            DELETED_KEYS=0
            LANGUAGES=0
          fi

          TOTAL=$((NEW_KEYS + MODIFIED_KEYS + DELETED_KEYS))

          if git diff --quiet --exit-code; then
            GIT_HAS_CHANGES=false
          else
            GIT_HAS_CHANGES=true
          fi

          echo "new_keys=$NEW_KEYS" >> "$GITHUB_OUTPUT"
          echo "modified_keys=$MODIFIED_KEYS" >> "$GITHUB_OUTPUT"
          echo "deleted_keys=$DELETED_KEYS" >> "$GITHUB_OUTPUT"
          echo "languages=$LANGUAGES" >> "$GITHUB_OUTPUT"

          if [ "$TOTAL" -gt 0 ] || [ "$GIT_HAS_CHANGES" = "true" ]; then
            echo "changes_detected=true" >> "$GITHUB_OUTPUT"
          else
            echo "changes_detected=false" >> "$GITHUB_OUTPUT"
          fi

          echo "Summary totals: new=$NEW_KEYS modified=$MODIFIED_KEYS deleted=$DELETED_KEYS"
          echo "Summary total changed keys: $TOTAL"
          echo "Git working tree changed: $GIT_HAS_CHANGES"
          git status --short

      - name: Get current date
        if: steps.check_changes.outputs.changes_detected == 'true'
        id: date
        run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        if: steps.check_changes.outputs.changes_detected == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            ğŸŒ Auto-translate localization strings

            - New keys: ${{ steps.check_changes.outputs.new_keys }}
            - Modified keys: ${{ steps.check_changes.outputs.modified_keys }}
            - Deleted keys: ${{ steps.check_changes.outputs.deleted_keys }}
            - Languages updated: ${{ steps.check_changes.outputs.languages }}
          branch: auto-translate/${{ steps.date.outputs.date }}
          delete-branch: true
          title: 'ğŸŒ Auto-translate localization strings (${{ steps.date.outputs.date }})'
          body: |
            ## ğŸ¤– Automated Translation Update

            This PR contains automated translations for localization string changes detected in the English base file.

            ### ğŸ“Š Summary

            - **New keys**: ${{ steps.check_changes.outputs.new_keys }}
            - **Modified keys**: ${{ steps.check_changes.outputs.modified_keys }}
            - **Deleted keys**: ${{ steps.check_changes.outputs.deleted_keys }}
            - **Languages updated**: ${{ steps.check_changes.outputs.languages }}

            ### ğŸŒ Languages

            - ğŸ‡©ğŸ‡ª German (de)
            - ğŸ‡«ğŸ‡· French (fr)
            - ğŸ‡ªğŸ‡¸ Spanish (es)
            - ğŸ‡µğŸ‡¹ Portuguese (pt)
            - ğŸ‡¹ğŸ‡­ Thai (th)
            - ğŸ‡²ğŸ‡¾ Malay (ms)

            ### âœ… What was done

            1. Detected changes in `AutotranslationTest/en.lproj/Localizable.strings`
            2. Translated new and modified strings using Claude API (Haiku model)
            3. Updated all language localization files
            4. Removed deleted keys from all language files
            5. Updated source of truth file (`.github/localization-keys.json`)

            ### ğŸ” Review Guidelines

            Please review the translations for:
            - Accuracy and context appropriateness
            - Proper preservation of placeholders (%@, %d, etc.)
            - Tone and formality consistency
            - Any strings marked as "TODO: Translation failed"

            ---

            *Generated by Auto-Translation Workflow*
            *Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}*
          labels: |
            localization
            automated
            translations

      - name: No changes detected
        if: steps.check_changes.outputs.changes_detected != 'true'
        run: |
          echo "âœ¨ No localization changes detected. Skipping PR creation."
